<!DOCTYPE html>
<html lang="zh-CN" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI-Tunnel</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            dark: { 800: '#1a1a2e', 900: '#0f0f23', 700: '#252547' }
          }
        }
      }
    }
  </script>
  <style>
    body { background: #0f0f23; color: #e2e8f0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
    .card { background: #1a1a2e; border: 1px solid #252547; border-radius: 12px; transition: all 0.2s; }
    .card:hover { border-color: #4f46e5; }
    .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }
    .status-healthy { background: #22c55e; box-shadow: 0 0 8px #22c55e88; }
    .status-unhealthy { background: #ef4444; box-shadow: 0 0 8px #ef444488; }
    .status-unknown { background: #eab308; box-shadow: 0 0 8px #eab30888; }
    .status-disabled { background: #6b7280; }
    .log-line { font-family: 'JetBrains Mono', 'Fira Code', monospace; font-size: 12px; line-height: 1.6; }
    .log-info { color: #22d3ee; }
    .log-warn { color: #eab308; }
    .log-error { color: #ef4444; }
    .log-debug { color: #6b7280; }
    .btn { padding: 6px 14px; border-radius: 8px; font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.15s; border: none; }
    .btn-primary { background: #4f46e5; color: white; }
    .btn-primary:hover { background: #4338ca; }
    .btn-danger { background: #dc2626; color: white; }
    .btn-danger:hover { background: #b91c1c; }
    .btn-ghost { background: transparent; color: #94a3b8; border: 1px solid #334155; }
    .btn-ghost:hover { background: #1e293b; color: #e2e8f0; }
    .stat-value { font-size: 20px; font-weight: 700; color: #f1f5f9; }
    .stat-label { font-size: 11px; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; }
    #logs { max-height: 280px; overflow-y: auto; scrollbar-width: thin; scrollbar-color: #334155 transparent; }
    #logs::-webkit-scrollbar { width: 6px; }
    #logs::-webkit-scrollbar-track { background: transparent; }
    #logs::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
    .fade-in { animation: fadeIn 0.3s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    .pulse { animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
  </style>
</head>
<body class="min-h-screen p-4 md:p-8">

  <!-- Header -->
  <div class="max-w-6xl mx-auto mb-6">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-3">
        <span class="text-2xl">ğŸš‡</span>
        <h1 class="text-xl font-bold text-white">AI-Tunnel</h1>
        <span id="version" class="text-xs text-slate-500 bg-slate-800 px-2 py-0.5 rounded">v2.0.0</span>
      </div>
      <div class="flex items-center gap-3">
        <div id="uptime" class="text-xs text-slate-500"></div>
        <span id="conn-status" class="status-dot status-unknown pulse" title="Connecting..."></span>
      </div>
    </div>
  </div>

  <!-- Auth bar (optional) -->
  <div class="max-w-6xl mx-auto mb-6">
    <div class="card p-4 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
      <div class="text-xs text-slate-500">
        å¦‚æœå¯ç”¨äº† <code class="text-slate-300">uiAuthToken</code>ï¼Œè¯·åœ¨è¿™é‡Œå¡« Tokenï¼ˆä»…ä¿å­˜åœ¨æœ¬åœ°æµè§ˆå™¨ï¼‰ã€‚
      </div>
      <div class="flex items-center gap-2">
        <input id="token" placeholder="Bearer token (optional)"
               class="bg-slate-900/40 border border-slate-700 rounded px-3 py-2 text-xs text-slate-200 w-72"
               autocomplete="off" />
        <button class="btn btn-ghost text-xs" onclick="applyToken()">Apply</button>
        <button class="btn btn-ghost text-xs" onclick="clearToken()">Clear</button>
      </div>
    </div>
  </div>

  <!-- Stats Bar -->
  <div class="max-w-6xl mx-auto mb-6">
    <div class="grid grid-cols-4 gap-4">
      <div class="card p-4 text-center">
        <div class="stat-value" id="stat-channels">-</div>
        <div class="stat-label">Channels</div>
      </div>
      <div class="card p-4 text-center">
        <div class="stat-value" id="stat-requests">0</div>
        <div class="stat-label">Total Requests</div>
      </div>
      <div class="card p-4 text-center">
        <div class="stat-value text-green-400" id="stat-success">0%</div>
        <div class="stat-label">Success Rate</div>
      </div>
      <div class="card p-4 text-center">
        <div class="stat-value text-cyan-400" id="stat-latency">-</div>
        <div class="stat-label">Avg Latency</div>
      </div>
    </div>
  </div>

  <!-- Channel Cards -->
  <div class="max-w-6xl mx-auto mb-6">
    <div class="flex items-center justify-between mb-3">
      <h2 class="text-sm font-semibold text-slate-400 uppercase tracking-wider">Channels</h2>
      <button class="btn btn-ghost text-xs" onclick="refreshChannels()">ğŸ”„ Refresh</button>
    </div>
    <div id="channels" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
      <div class="card p-6 flex items-center justify-center text-slate-500">
        <span class="pulse">Loading channels...</span>
      </div>
    </div>
  </div>

  <!-- Logs -->
  <div class="max-w-6xl mx-auto">
    <div class="flex items-center justify-between mb-3">
      <h2 class="text-sm font-semibold text-slate-400 uppercase tracking-wider">ğŸ“‹ Live Logs</h2>
      <div class="flex gap-2">
        <button class="btn btn-ghost text-xs" onclick="clearLogs()">Clear</button>
        <label class="flex items-center gap-1 text-xs text-slate-500">
          <input type="checkbox" id="auto-scroll" checked class="accent-indigo-500"> Auto-scroll
        </label>
      </div>
    </div>
    <div class="card p-4">
      <div id="logs"></div>
      <div id="log-empty" class="text-center text-slate-600 text-sm py-4">Waiting for events...</div>
    </div>
  </div>

<script>
// â”€â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let channels = [];
let eventSource = null;
let authToken = localStorage.getItem('ai_tunnel_token') || '';

// â”€â”€â”€ API Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const API = '';

async function api(path, opts = {}) {
  const headers = { 'Content-Type': 'application/json' };
  if (authToken) headers['Authorization'] = 'Bearer ' + authToken;

  const res = await fetch(API + path, {
    headers,
    ...opts,
  });
  return res.json();
}

function applyToken() {
  const v = document.getElementById('token').value.trim();
  authToken = v;
  localStorage.setItem('ai_tunnel_token', v);
  reconnectSSE();
  refreshChannels();
  updateUptime();
}

function clearToken() {
  authToken = '';
  localStorage.removeItem('ai_tunnel_token');
  document.getElementById('token').value = '';
  reconnectSSE();
  refreshChannels();
  updateUptime();
}

// â”€â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderChannels(data) {
  channels = data;
  const container = document.getElementById('channels');

  if (!data.length) {
    container.innerHTML = '<div class="card p-6 text-center text-slate-500">No channels configured</div>';
    return;
  }

  container.innerHTML = data.map(ch => {
    const statusClass = !ch.enabled ? 'status-disabled' :
      ch.health === 'healthy' ? 'status-healthy' :
      ch.health === 'unhealthy' ? 'status-unhealthy' : 'status-unknown';

    const statusText = !ch.enabled ? 'Disabled' :
      ch.health === 'healthy' ? 'Online' :
      ch.health === 'unhealthy' ? 'Offline' : 'Checking...';

    const successRate = ch.stats.totalRequests > 0
      ? ((ch.stats.successCount / ch.stats.totalRequests) * 100).toFixed(1) + '%'
      : '--';

    const latency = ch.latency != null ? ch.latency + 'ms' : '--';

    return `
      <div class="card p-5 fade-in">
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center gap-2">
            <span class="status-dot ${statusClass}"></span>
            <span class="font-semibold text-white">${esc(ch.name)}</span>
            ${ch.fallback ? '<span class="text-xs bg-amber-900/50 text-amber-400 px-1.5 py-0.5 rounded">backup</span>' : ''}
          </div>
          <span class="text-xs text-slate-500">${statusText}</span>
        </div>

        <div class="text-xs text-slate-500 mb-3 truncate" title="${esc(ch.target)}">
          ${esc(ch.target)}
        </div>

        <div class="grid grid-cols-4 gap-2 mb-4 text-center">
          <div>
            <div class="text-sm font-bold text-cyan-400">${latency}</div>
            <div class="text-[10px] text-slate-600">Latency</div>
          </div>
          <div>
            <div class="text-sm font-bold text-green-400">${successRate}</div>
            <div class="text-[10px] text-slate-600">Success</div>
          </div>
          <div>
            <div class="text-sm font-bold text-slate-300">${ch.stats.totalRequests}</div>
            <div class="text-[10px] text-slate-600">Requests</div>
          </div>
          <div>
            <div class="text-sm font-bold ${ch.keys.alive === ch.keys.total ? 'text-green-400' : 'text-amber-400'}">${ch.keys.alive}/${ch.keys.total}</div>
            <div class="text-[10px] text-slate-600">Keys</div>
          </div>
        </div>

        <div class="flex gap-2">
          <button class="btn ${ch.enabled ? 'btn-danger' : 'btn-primary'} flex-1 text-xs"
                  onclick="toggleChannel('${esc(ch.name)}')">
            ${ch.enabled ? 'â¸ Pause' : 'â–¶ï¸ Enable'}
          </button>
        </div>
      </div>
    `;
  }).join('');

  // Update stats bar
  const healthy = data.filter(c => c.health === 'healthy').length;
  document.getElementById('stat-channels').textContent = `${healthy}/${data.length}`;

  const totalReq = data.reduce((s, c) => s + c.stats.totalRequests, 0);
  const totalOk = data.reduce((s, c) => s + c.stats.successCount, 0);
  document.getElementById('stat-requests').textContent = totalReq.toLocaleString();
  document.getElementById('stat-success').textContent = totalReq > 0
    ? ((totalOk / totalReq) * 100).toFixed(1) + '%' : '--';

  const latencies = data.filter(c => c.latency != null).map(c => c.latency);
  const avgLatency = latencies.length > 0
    ? Math.round(latencies.reduce((a, b) => a + b, 0) / latencies.length) : null;
  document.getElementById('stat-latency').textContent = avgLatency != null ? avgLatency + 'ms' : '--';
}

function appendLog(entry) {
  const container = document.getElementById('logs');
  const emptyEl = document.getElementById('log-empty');
  if (emptyEl) emptyEl.style.display = 'none';

  const level = entry.level || 'info';
  const tag = entry.tag || entry.channel || '';
  const msg = entry.message || '';
  const time = entry.time ? new Date(entry.time).toLocaleTimeString('en-US', { hour12: false }) : '';

  const icons = { debug: 'ğŸ”', info: 'âœ…', warn: 'âš ï¸', error: 'âŒ' };
  const icon = icons[level] || '';

  const line = document.createElement('div');
  line.className = `log-line log-${level}`;
  line.textContent = `${time} ${icon} [${tag}] ${msg}`;
  container.appendChild(line);

  // Limit log lines
  while (container.children.length > 200) {
    container.removeChild(container.firstChild);
  }

  if (document.getElementById('auto-scroll').checked) {
    container.scrollTop = container.scrollHeight;
  }
}

// â”€â”€â”€ Actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function toggleChannel(name) {
  await api(`/api/channels/${encodeURIComponent(name)}/toggle`, { method: 'POST' });
  refreshChannels();
}

async function refreshChannels() {
  try {
    const data = await api('/api/channels');
    renderChannels(data);
  } catch (e) {
    console.error('Failed to fetch channels:', e);
  }
}

function clearLogs() {
  document.getElementById('logs').innerHTML = '';
  document.getElementById('log-empty').style.display = 'block';
}

// â”€â”€â”€ SSE Connection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function reconnectSSE() {
  if (eventSource) eventSource.close();
  const dot = document.getElementById('conn-status');

  // EventSource cannot set headers, so use query param token
  const tokenQ = authToken ? ('?token=' + encodeURIComponent(authToken)) : '';
  eventSource = new EventSource('/api/logs' + tokenQ);

  eventSource.onopen = () => {
    dot.className = 'status-dot status-healthy';
    dot.title = 'Connected';
  };

  eventSource.onmessage = (e) => {
    try {
      const data = JSON.parse(e.data);

      // It's a log entry
      if (data.level && data.message) {
        appendLog(data);
      }

      // It's an event with type
      if (data.type === 'request' || data.type === 'health' || data.type === 'channel_toggle') {
        // Refresh channels on state-changing events
        refreshChannels();
      }

      if (data.type === 'log') {
        appendLog(data);
      }

      // Retry event
      if (data.type === 'retry') {
        appendLog({
          time: new Date().toISOString(),
          level: 'warn',
          tag: 'Retry',
          message: `Attempt ${data.attempt + 1}/${data.maxAttempts} from ${data.fromChannel} (delay: ${data.delay}ms)`,
        });
      }
    } catch { /* ignore parse errors */ }
  };

  eventSource.onerror = () => {
    dot.className = 'status-dot status-unhealthy pulse';
    dot.title = 'Disconnected, reconnecting...';
  };
}

// â”€â”€â”€ Uptime â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateUptime() {
  api('/api/status').then(data => {
    const s = data.uptime;
    const h = Math.floor(s / 3600);
    const m = Math.floor((s % 3600) / 60);
    document.getElementById('uptime').textContent = `Uptime: ${h}h ${m}m`;
  }).catch(() => {});
}

// â”€â”€â”€ Escape HTML â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function esc(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

// â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function init() {
  document.getElementById('token').value = authToken;
  refreshChannels();
  reconnectSSE();
  updateUptime();
  setInterval(refreshChannels, 10000);
  setInterval(updateUptime, 30000);
})();
</script>
</body>
</html>
